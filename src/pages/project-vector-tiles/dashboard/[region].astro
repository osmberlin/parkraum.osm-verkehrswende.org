---
import { PageDashboardDate } from '@components/PageDashbard/PageDashboardDate'
import { PageDashboardTable } from '@components/PageDashbard/PageDashboardTable'
import LayoutArticlePage from '@layouts/LayoutArticlePage.astro'
import { Octokit } from '@octokit/rest'
import { bbox, centerOfMass } from '@turf/turf'
import axios from 'axios'

export async function getStaticPaths() {
  const octokit = new Octokit()
  const githubContent = await octokit.repos.getContent({
    owner: 'osmberlin',
    repo: 'osm-parking-processing',
    ref: 'docker', // For now, until the branch is merged into `main`
    path: '/extracts/boundaries',
  })
  const githubFiles = githubContent.data
    // @ts-ignore no idea how to guard this from TS
    ?.filter((file: any) => file.type === 'file')
    ?.map((file: any) => {
      const res = {
        filename: file.name,
        downloadUrl: file.download_url,
        url: file.html_url,
        content: null,
      }
      return res
    })

  // Fetch the content for the files
  const githubFilesWithContent = await Promise.all(
    githubFiles.map(async (file: any) => {
      const resp = await axios.get(file.downloadUrl)
      const content = await resp.data
      const slug = file.filename.replace('.geojson', '')
      const name = slug.charAt(0).toUpperCase() + slug.slice(1)
      const bounds = bbox(content)
      const center = centerOfMass(content)

      return { ...file, slug, name, content, bounds, center }
    })
  )

  const regions = await githubFilesWithContent.map((region) => {
    return { params: { region: region.slug }, props: { data: region } }
  })

  return regions
}

// const { region } = Astro.params
const { data } = Astro.props
---

<LayoutArticlePage
  title='Dashboard aus dem Projekt "Vector Tiles"'
  noindex={true}
  menuHighlight="project_vector_tiles_dashboard"
  maxWidthClass="max-w-7xl lg:pr-10"
>
  <h1>Parkraum {data.name}: Statistiken</h1>
  <p class="mt-2 text-sm text-gray-700">
    Die Liste zeigt pro Bezirk bzw. Ortsteil, wie hoch der Anteil der StraÃŸen ist, fÃ¼r die in OSM
    bereits Parkstreifendaten erfasst sind.
  </p>
  <!-- {JSON.stringify(data)} -->
  <p class="notice prose my-6 bg-orange-100">
    ğŸ‘‰ <b>Aktueller Hinweis:</b> Das Parkraumschema in OpenStreetMap wird derzeit erneuert. Unsere Karte
    zeigt nur die neuste Version des OSM-Parkraum-Schemas an. Wenn du in OpenStreetMap dabei helfen mÃ¶chtest,
    die Daten zu aktualisieren, kannst du <a
      href="https://www.openstreetmap.org/user/Supaplex030/diary/401053">hier nachlesen</a
    >, wie das mÃ¶glich ist.
  </p>

  <PageDashboardDate client:idle />
  <div class="mt-8 flex flex-col">
    <div class="overflow-hidden shadow ring-1 ring-black/5 md:rounded-lg">
      <PageDashboardTable client:load regionKey={data.slug} />
    </div>
  </div>
</LayoutArticlePage>
